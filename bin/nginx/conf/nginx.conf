
#user  nobody;
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # Dynamic Virtual Hosts (*.test)
    # Maps http://project.test -> sites/project
    server {
        listen       80;
        server_name  ~^(?<project>.+)\.test$;
        
        # Dynamic root based on domain name
        root   D:/Lab/HomeLab/Github/dyzulk/LUHUT/sites/$project;
        
        index  index.php index.html index.htm;
        autoindex on;

        location / {
            try_files $uri $uri/ =404;
        }

        # Pass PHP scripts to FastCGI
        location ~ \.php$ {
            fastcgi_pass   127.0.0.1:9000;
            fastcgi_index  index.php;
            
            # Fix SCRIPT_FILENAME for Windows dynamic paths
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            include        fastcgi_params;
        }

        # Shared Error Pages (From System)
        error_page 404 /errors/404.html;
        error_page 500 503 504 /errors/50x.html;
        error_page 502 /errors/502.html;
        
        location ^~ /errors/ {
            internal;
            root D:/Lab/HomeLab/Github/dyzulk/LUHUT/bin/system;
        }
        location ^~ /assets/ {
            root D:/Lab/HomeLab/Github/dyzulk/LUHUT/bin/system;
        }
    }

    # Default Server (Localhost) - Serves System Dashboard/Parking Page
    server {
        listen       80;
        server_name  localhost;

        # Point to System Directory
        root   D:/Lab/HomeLab/Github/dyzulk/LUHUT/bin/system;
        
        index  index.php index.html index.htm;
        autoindex on;

        location / {
            try_files $uri $uri/ =404;
        }

        location ~ \.php$ {
            fastcgi_pass   127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            include        fastcgi_params;
        }

        # Error handling also points to system
        error_page 404 /errors/404.html;
        location ^~ /errors/ {
            internal;
            root D:/Lab/HomeLab/Github/dyzulk/LUHUT/bin/system;
        }
        location ^~ /assets/ {
            root D:/Lab/HomeLab/Github/dyzulk/LUHUT/bin/system;
        }
    }
}
